# Class for url penetration testing
# @author Strnadj <jan.strnadek@gmail.com>

require 'net/http'
require 'open-uri'
require_relative 'support_classes/url_vector.rb'

module ContentTester
  class UrlTester
    attr_accessor :parser_results, :options

    # Constructor of UrlTester class
    # @param [Hash] parser_results Parser results
    # @param [Hash] options        Options from CLI
    def initialize(parser_results, options)
      @parser_results = parser_results
      @options = options
    end

    # Create url
    # @param [String] url URL
    # @param [Array] parameters Parameters
    # @return [URI] URI reference
    def create_url(url, parameters)
      ret = URI(url)
      ret.query = URI.encode_www_form(parameters)
      return ret
    end

    # Link testing
    # @return nil
    def test_links()
     # Parse links
        puts "Test links:".bold.red << "\n" if @options[:debug]

        @parser_results[:links].each {
            |link|
            attr = link.attr

            puts "\tTest: ".yellow.bold << link.url << "\n" if @options[:debug]

            # Iterate parameters
            for i in 0..(attr.count - 1)

              # Get original request
              original = get_request(link.get_uri())

              # Test 404 error
              if original[:code] == 404
                puts "\t\tError: ".red.bold << "404 - not found" << "\n" if @options[:debug]
                next
              end

              # original vector
              original_vector = URLVector::get_vector(Nokogiri::HTML(original[:body]))

              # directives?
              unless options[:error_directive]
                # Add ' to try to break
                attr_c = Marshal.load(Marshal.dump(attr))
                attr_c[i][1] += "'"

                # Test res
                test_res = get_request(create_url(link.url, attr_c))
                
                # Test to 404 error?
                if test_res[:code] == 404
                  puts "\t\tError: ".red.bold << "404 - not found" << "\n" if @options[:debug]
                  next
                end

                # Test result error
                if self.compare_results_error(original[:body], test_res[:body])
                  puts "\t\tParam: ".red.bold << attr_c[i][0] << " - probably " << "UNSECURED".bold.red << "\n"  if @options[:debug]
                  puts "\t\t" << create_url(link.url, attr_c).to_s << "\n\n" if @options[:debug]
                end
              else
                # Add all parameters
                break_request = Marshal.load(Marshal.dump(attr))
                break_request[i][1] += "'"

                comment_request = Marshal.load(Marshal.dump(attr))
                comment_request[i][1] += "' -- "

                logic_true_request = Marshal.load(Marshal.dump(attr))
                logic_true_request[i][1] += "' OR '1' = '1"
                
                # Call get request
                break_request_s = get_request(create_url(link.url, break_request))
                comment_request_s = get_request(create_url(link.url, comment_request))
                logic_true_request_s = get_request(create_url(link.url, logic_true_request))
                
                # Count differences
                break_request_diff = self.get_diff_vector_weight(original_vector, break_request_s)
                comment_request_diff = self.get_diff_vector_weight(original_vector, comment_request_s)
                logic_true_request_diff = self.get_diff_vector_weight(original_vector, logic_true_request_s)

                # If there is 1 attribute, there will be no change when comment rest of request
                suspect = false
                
                # Cause there is invalid SQL query
                suspect = true if break_request_diff > 0

                # Cause there is less conditions
                suspect = true if comment_request_diff < 0

                # Cause there is LOGICAL true - more results!
                suspect = true if logic_true_request_diff < 0

                if suspect
                  puts "\t\tParam: ".red.bold << logic_true_request[i][0] << " - probably " << "UNSECURED - different results!".bold.red << "\n"  if @options[:debug]
                  puts "\t\t\t" << create_url(link.url, break_request).to_s << "\n\t\t\t" << create_url(link.url, comment_request).to_s << "\n\t\t\t" << create_url(link.url, logic_true_request).to_s if @options[:debug]
                end
              end
            end
      }
    end

    # Method returrn weight of vector differences
    # @param [URLVector] original_vector Original vector
    # @param [ResultRequest] result_request Result of request
    def get_diff_vector_weight(original_vector, result_request)
      new_vector = URLVector::get_vector(Nokogiri::HTML(result_request[:body]))
      difference = URLVector::difference(original_vector, new_vector)
      return URLVector::vector_weight(difference)
    end

    # Method for testing get forms
    # @return nil
    def test_get_forms()
      # Parse get forms
      puts "Test get forms:".bold.green << "\n" if @options[:debug]
      @parser_results[:get_forms].each {
        |form|

        # Debug output
        puts "\tTest: ".yellow.bold << form.action << "\n" if @options[:debug]

        # Iterate parameters
        for i in 0..(form.params.count - 1)
          # Get modify request
          modify_request = add_symbol_to_form_request(form.params, i, "'")

          # Param array ready
          original = get_request(form.get_uri())
          test_res = get_request(create_url(form.action, modify_request[:request]))

          # Test 404 error
          if original[:code] == 404 || test_res[:code] == 404
            puts "\t\tError: ".red.bold << "404 - not found" << "\n" if @options[:debug]
            next
          end

          # Test parameters
          if options[:error_directive]
            if self.compare_results_error(original[:body], test_res[:body])
              puts "\t\tParam: ".red.bold << modify_request[:name] << " - probably " << "UNSECURED".bold.red << "\n"  if @options[:debug]
              puts "\t\t" << create_url(form.action, modify_request[:request]).to_s << "\n\n" if @options[:debug]
            end
          else

          end
        end
      }
    end

    # Method add to request parameters special symbol for testing SQL injection
    # @param [Array] params Form parameters
    # @param [Integer] iteration Interations number
    # @param [String] symbol Symbol to add
    # @return [Hash] updated parameters
    def add_symbol_to_form_request(params, iteration, symbol)
      # Return test request
      ret = Hash.new

      # Return hash
      ret[:request] = Hash.new
      ret[:name] = ''

      # In i is argument for substitution
      for a in 0..(params.count - 1)
        param = params[a]

        # Checkbox?
        if param[:type] == "checkbox"
          if a == iteration
            ret[:name] = param[:name]
            ret[:request][param[:name]] = "1" + symbol
          else
            ret[:request][param[:name]] = "1"
          end
        elsif param[:type] == "select"
          if a == iteration
            ret[:name] = param[:name]
            ret[:request][param[:name]] = param[:values][0] + symbol
          else
            ret[:request][param[:name]] = param[:values][0]
          end
        else
          if a == iteration
            ret[:name] = param[:name]
            ret[:request][param[:name]] = "test" + symbol
          else
            ret[:request][param[:name]] = "test"
          end
        end
      end

      # Return test request
      ret
    end

    # Method for testing post forms
    # @return nil
    def test_post_forms()
      puts "Test post forms:".bold.green << "\n" if @options[:debug]
      @parser_results[:post_forms].each {
        |form|

        # Debug output
        puts "\tTest: ".yellow.bold << form.action << "\n" if @options[:debug]

        # Iterate parameters
        for i in 0..(form.params.count - 1)
          # Get original request
          post_uri = URI(form.action)
          original = post_request(post_uri, form.get_attr())
          original_vector = URLVector::get_vector(Nokogiri::HTML(original[:body]))

          # PHP error directives
          unless options[:error_directive]
            # Get modify request
            modify_request = add_symbol_to_form_request(form.params, i, "'")

            # Param array ready
            test_res = post_request(post_uri, modify_request[:request])

            # Test 404 error
            if original[:code] == 404 || test_res[:code] == 404
              puts "\t\tError: ".red.bold << "404 - not found" << "\n" if @options[:debug]
              next
            end

            # Test if error directives are ON
            if self.compare_results_error(original[:body], test_res[:body])
              puts "\t\tParam: ".red.bold << modify_request[:name] << " - probably " << "UNSECURED".bold.red << "\n"  if @options[:debug]
              puts "\t\t" << post_uri.to_s << "(attr: " << modify_request[:request].to_s << ")\n\n" if @options[:debug]
            end
          else
            # Test to compare URL vectors from content
            break_request = add_symbol_to_form_request(form.params, i, "'")
            comment_request = add_symbol_to_form_request(form.params, i, "' -- ")
            logic_true_request = add_symbol_to_form_request(form.params, i, "' OR '1' = '1")

            # Send request and calculate URL vectors
            break_request_s = post_request(post_uri, break_request[:request])
            comment_request_s = post_request(post_uri, break_request[:request])
            logic_true_request_s = post_request(post_uri, logic_true_request[:request])

            # Try to test 30x - redirects, cause Login-form successfull log-in
            if comment_request[:code] == "300"
                puts "\t\tParam: ".red.bold << comment_request[:name] << " - probably " << "UNSECURED - redirection after modification!".bold.red << "\n"  if @options[:debug]
                puts "\t\t" << post_uri.to_s << "(attr: " << comment_request[:request].to_s << ")\n\n" if @options[:debug]
            end
            
            if logic_true_request[:code] == "300"
                # Something happend not correctly - maybe successfull login redirect
                puts "\t\tParam: ".red.bold << logic_true_request[:name] << " - probably " << "UNSECURED - redirection after modification!".bold.red << "\n"  if @options[:debug]
                puts "\t\t" << post_uri.to_s << "(attr: " << logic_true_request[:request].to_s << ")\n\n" if @options[:debug]
            end

            # Create URL vectors
            break_request_vector = URLVector::get_vector(Nokogiri::HTML(break_request_s[:body]))
            comment_request_vector = URLVector::get_vector(Nokogiri::HTML(comment_request_s[:body]))
            logic_true_vector = URLVector::get_vector(Nokogiri::HTML(logic_true_request_s[:body]))

            # Count differences
            break_request_diff = URLVector::vector_weight(URLVector::difference(original_vector, break_request_vector))
            comment_request_diff = URLVector::vector_weight(URLVector::difference(original_vector, comment_request_vector))
            logic_true_request_diff = URLVector::vector_weight(URLVector::difference(original_vector, logic_true_vector))

            # Test Sizes!!!
            puts "\t\tParam: ".red.bold << logic_true_request[:name] << "\n"
            puts "Differences:\n" << "Break request: " << break_request_diff.to_s << "\nComment: " << comment_request_diff.to_s << "\nLogic true: " << logic_true_request_diff.to_s << "\n"
              
          end
        end
      }
    end

    # Method for start test
    # @return nil
    def start_test()
      print "= Start testing: =\n".bold.green if @options[:debug]

      # Run start testing a
      test_links()

      # Parse post forms
      test_post_forms()

      # Parse get forms
      test_get_forms()
    end

    # Send get request with specified parameters
    # @param [URI] uri Request url
    # @return [String] Response body
    def get_request(uri)
      ret = Hash.new
      size = 1000
      http = Net::HTTP.new(uri.host, uri.port)
      headers = {
          'Range' => "bytes=#{size}-"
      }
      path = uri.to_s.empty? ? "/" : uri.to_s

      ret[:code] = http.head(path, headers).code.to_i

      ret[:body] = Net::HTTP.get_response(uri).body

      ret
    end

    # Send post request with specified parameters
    # @param [URI] uri Request url
    # @return [String] Response body
    # @param [Hash] attr Attributes
    def post_request(uri, attr)
      ret = Hash.new
      size = 1000
      http = Net::HTTP.new(uri.host, uri.port)
      headers = {
          'Range' => "bytes=#{size}-"
      }
      path = uri.to_s.empty? ? "/" : uri.to_s

      ret[:code] = http.head(path, headers).code.to_i

      ret[:body] = Net::HTTP.post_form(uri, attr).body

      ret
    end


    # Compare results from two pages if there is error directives ON
    # @param [String] before Before change tags
    # @param [String] after  After change parameter
    # @return [Boolean] True or false if there is suspicion for SQLi
    def compare_results_error(before, after)
      return (after.include? "Warning: mysql_") ||  (after.include? "Error: mysql_") ||  (after.include? "Fatal Error: mysql_") || (after.include? "error: mysql_") || (after.include? "<b>Warning</b>:  mysql_")
    end

  end
end
