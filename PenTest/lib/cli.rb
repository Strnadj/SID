# Pen Test - in ruby
# @author Jan Strnadek <jan.strnadek@gmail.com>

require_relative './parser/parser'
require_relative './tester/url_tester'

require 'optparse'
require 'ostruct'
require 'open-uri'
require 'colored'

module PenTest
  class CLI
    # Start CLI interface, parse options etc..
    # @return [nil] Nothing
    def self.start()
    # Parse options from cmd
    options = OptParse.parse(ARGV)

    # Create parser
    parser = Parser::UrlParser.new(options)

    # Run parser
    parser.start_parsing()

    # Get result
    result = parser.get_results()

    # Options debug? results
    if options[:debug]
      puts "\n = Parser results: = ".bold.red << "\n"
      puts '   Links total: ' << result[:links].count().to_s.bold.yellow << "\n"
      puts '   Forms total: ' << (result[:post_forms].count() + result[:get_forms].count()).to_s.bold.yellow << "\n\n"
    end

    # Create tester
    url_tester = ContentTester::UrlTester.new(result, options)

    # Start parsing
    url_tester.start_test()

    # Exit
    exit 0
    end
  end

  # Option parser
  class OptParse
    def self.parse(args)
      # Options specified from cmd
      options = {}
      options[:base_url] = nil
      options[:depth_level] = 0
      options[:full_domain] = true
      options[:output_text] = nil
      options[:error_directive] = true
      options[:debug] = false
      options[:crazy] = false

      # Base URL! - non-optional parameter!
      opts = OptionParser.new do |opts|
        opts.banner = "Welcome to SID - SQL Injection Detector script\n".red << "\tAuthor:".green << " Strnadj <jan.strnadek@gmail.com>\n\t" << "Agreement:".green << " Only for studding purposes!\n\nUsage: ./pentest [options]"

        opts.separator ''
        opts.separator 'Required options:'

        # Required argument - URL
        opts.on('-u', '--url URL', 'Required base URL') do |url|
          options[:base_url] = url
        end

        opts.separator ''
        opts.separator 'Specific options:'

        # Depth level
        opts.on('-l', '--depth-level N', Integer, 'Depth level (default 0 - all levels)') do |level|
          options[:depth_level] = level
        end

        opts.on('-d', '--debug BOOL', 'Debug output (default FALSE)') do |debug|
          options[:debug] = debug
        end

        opts.on('-f', '--full-domain [BOOL]', 'Full domain (wildcards http://*.web.com/ - default TRUE)') do |fd|
          options[:full_domain] = fd
        end

        opts.on('-o', '--output [FILENAME]', 'File for text output (default NULL)') do |filename|
          options[:output_text] = filename
        end

        opts.on('-e', '--error-directive [BOOL]', 'Error directive E~ALL (if false - experimental behaviour - default TRUE)') do |directive|
          options[:error_directive] = directive
        end

        opts.on('-c', '--crazy-behaviour [BOOL]', 'Crazy behaviour test - add everywhere DROP ALL TABLES; - default FALSE') do |crazy|
          options[:crazy] = crazy
        end

        opts.separator ''
        opts.separator 'Common options:'

        opts.on_tail('-h', '--help', 'Show this help') do
          puts opts
          exit
        end

        opts.on_tail('-v', '--version', 'Show version') do
          print "SID 0.1\n"
          exit
        end
      end

      opts.parse!(args)

      # Check required argument - BASE URL
      if !options[:base_url]
        puts opts
        exit
      end

      options
    end
  end
end



